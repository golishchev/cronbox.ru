# Manual deployment and rollback workflow
# Pulls pre-built images from GHCR and deploys to production
# Images are built by CI on push to main

name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - rollback
      ref:
        description: 'Git ref to deploy (commit SHA, branch, tag)'
        required: false
        default: 'main'
      components:
        description: 'Components to deploy (comma-separated: backend,frontend,landing or "all")'
        required: false
        default: 'all'

env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/cronbox

jobs:
  deploy:
    name: ${{ github.event.inputs.action == 'rollback' && 'Rollback' || 'Deploy' }}
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: read
    environment:
      name: production
      url: https://cronbox.ru

    steps:
      - name: ${{ github.event.inputs.action == 'rollback' && 'Rollback' || 'Deploy' }} via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          COMPONENTS: ${{ github.event.inputs.components }}
          ACTION: ${{ github.event.inputs.action }}
          REF: ${{ github.event.inputs.ref }}
          IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/cronbox
          GHCR_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GHCR_USER: ${{ github.actor }}
        with:
          host: ${{ secrets.SSH_HOST }}
          port: ${{ secrets.SSH_PORT }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          envs: COMPONENTS,ACTION,REF,IMAGE_PREFIX,GHCR_TOKEN,GHCR_USER
          script: |
            set -e
            cd /opt/cronbox

            echo "==> Action: $ACTION"
            echo "==> Components: $COMPONENTS"

            # Login to GHCR
            echo "$GHCR_TOKEN" | docker login ghcr.io -u "$GHCR_USER" --password-stdin

            if [ "$ACTION" = "rollback" ]; then
              echo "==> Rolling back to previous commit..."
              git checkout HEAD~1
              IMAGE_TAG=$(git rev-parse HEAD)
            else
              echo "==> Deploying ref: $REF"
              git fetch origin
              git checkout "$REF"
              IMAGE_TAG=$(git rev-parse HEAD)
            fi

            echo "==> Image tag: $IMAGE_TAG"

            # Check infrastructure
            RUNNING_SERVICES=$(docker compose -f docker-compose.prod.yml ps --services --filter "status=running" 2>/dev/null || echo "")
            NEED_INFRA=false
            for service in postgres redis traefik; do
              if ! echo "$RUNNING_SERVICES" | grep -q "^${service}$"; then
                echo "Service $service is not running"
                NEED_INFRA=true
              fi
            done

            if [ "$NEED_INFRA" = true ]; then
              echo "==> Starting infrastructure..."
              docker compose -f docker-compose.prod.yml stop worker scheduler bot api 2>/dev/null || true
              sleep 5
              docker compose -f docker-compose.prod.yml up -d postgres redis traefik prometheus grafana redis-exporter postgres-exporter
              sleep 30
              docker compose -f docker-compose.prod.yml up -d api
              sleep 3
              docker compose -f docker-compose.prod.yml up -d worker scheduler bot
            fi

            deploy_backend() {
              echo "==> Pulling backend image..."
              docker pull ${IMAGE_PREFIX}-api:${IMAGE_TAG}
              docker tag ${IMAGE_PREFIX}-api:${IMAGE_TAG} cronboxru-api:latest
              echo "==> Deploying backend..."
              docker compose -f docker-compose.prod.yml stop worker scheduler bot 2>/dev/null || true
              sleep 3
              docker compose -f docker-compose.prod.yml up -d --no-deps api
              sleep 3
              docker compose -f docker-compose.prod.yml up -d --no-deps worker scheduler bot
            }

            deploy_frontend() {
              echo "==> Pulling frontend image..."
              docker pull ${IMAGE_PREFIX}-frontend:${IMAGE_TAG}
              docker tag ${IMAGE_PREFIX}-frontend:${IMAGE_TAG} cronboxru-frontend:latest
              echo "==> Deploying frontend..."
              docker compose -f docker-compose.prod.yml up -d --no-deps frontend
            }

            deploy_landing() {
              echo "==> Pulling landing image..."
              docker pull ${IMAGE_PREFIX}-landing:${IMAGE_TAG}
              docker tag ${IMAGE_PREFIX}-landing:${IMAGE_TAG} cronboxru-landing:latest
              echo "==> Deploying landing..."
              docker compose -f docker-compose.prod.yml up -d --no-deps landing
            }

            # Deploy selected components
            DEPLOYED=""
            if [ "$COMPONENTS" = "all" ]; then
              # When deploying "all", skip components whose images weren't built
              if docker pull ${IMAGE_PREFIX}-api:${IMAGE_TAG} 2>/dev/null; then
                docker tag ${IMAGE_PREFIX}-api:${IMAGE_TAG} cronboxru-api:latest
                echo "==> Deploying backend..."
                docker compose -f docker-compose.prod.yml stop worker scheduler bot 2>/dev/null || true
                sleep 3
                docker compose -f docker-compose.prod.yml up -d --no-deps api
                sleep 3
                docker compose -f docker-compose.prod.yml up -d --no-deps worker scheduler bot
                DEPLOYED="$DEPLOYED backend"
              else
                echo "==> Skipping backend (image not found for this commit)"
              fi

              if docker pull ${IMAGE_PREFIX}-frontend:${IMAGE_TAG} 2>/dev/null; then
                docker tag ${IMAGE_PREFIX}-frontend:${IMAGE_TAG} cronboxru-frontend:latest
                echo "==> Deploying frontend..."
                docker compose -f docker-compose.prod.yml up -d --no-deps frontend
                DEPLOYED="$DEPLOYED frontend"
              else
                echo "==> Skipping frontend (image not found for this commit)"
              fi

              if docker pull ${IMAGE_PREFIX}-landing:${IMAGE_TAG} 2>/dev/null; then
                docker tag ${IMAGE_PREFIX}-landing:${IMAGE_TAG} cronboxru-landing:latest
                echo "==> Deploying landing..."
                docker compose -f docker-compose.prod.yml up -d --no-deps landing
                DEPLOYED="$DEPLOYED landing"
              else
                echo "==> Skipping landing (image not found for this commit)"
              fi

              if [ -z "$DEPLOYED" ]; then
                echo "ERROR: No images found for any component at tag ${IMAGE_TAG}"
                exit 1
              fi
              echo "==> Deployed:$DEPLOYED"
            else
              # Explicit component selection â€” fail if image is missing
              if echo "$COMPONENTS" | grep -q "backend"; then
                deploy_backend
              fi
              if echo "$COMPONENTS" | grep -q "frontend"; then
                deploy_frontend
              fi
              if echo "$COMPONENTS" | grep -q "landing"; then
                deploy_landing
              fi
            fi

            # Cleanup
            echo "==> Cleaning up..."
            docker image prune -f --filter "until=168h"

            # Health check
            echo "==> Health check..."
            curl -sf --retry 3 --retry-delay 2 https://api.cronbox.ru/health && echo "API OK" || echo "Warning: API health check failed"

            echo "==> Done!"
            git log -1 --oneline
